- hosts: localhost
  connection: local

  vars:
    zabbix_version: 5.0
    php_version: '7.2'
    php_default_version_debian: '7.2'
    php_webserver_daemon: "httpd"
    php_packages_state: latest

  tasks:
      
    -   name: Check the version of OS
        command: hostnamectl
        register: os_check
        ignore_errors: yes 

    -   name: Fetch Zabbix Role
        git:
            repo: https://ro:h6sWfioy4fwBqnzsM6oC@pwslab.org/ansible/zabbix-playbook.git
            dest: /root/.ansible/roles/pwslab.zabbix
            version: master
            force: yes

    -   name: Install Role PHP
        local_action: command ansible-galaxy install -f geerlingguy.php

    -   name: Install Role PHP-VERSIONS
        local_action: command ansible-galaxy install -f geerlingguy.php-versions

    -   name: Install Role REMI
        local_action: command ansible-galaxy install -f geerlingguy.repo-remi 

    -   name: Install Role Apache
        local_action: command ansible-galaxy install -f geerlingguy.apache 

    -   name: Install Role MySQL
        local_action: command ansible-galaxy install -f geerlingguy.mysql

    -   name: Check if MYSQL is already installed
        stat: path=/usr/bin/mysql
        register: mysql_exists

    -   name: Check if Apache is already installed
        stat: path=/usr/sbin/httpd
        register: apache_exists

    -   name: Check if PHP is already installed
        stat: path=/usr/bin/php
        register: php_exists

    -   name: Applying role PHP
        command: mv ~/.ansible/roles/geerlingguy.php ~/.ansible/roles/pwslab.php
        when: not php_exists.stat.exists
        ignore_errors: yes
    
    -   name: Applying role REMI
        command: mv ~/.ansible/roles/geerlingguy.repo-remi  ~/.ansible/roles/pwslab.repo-remi 
        when: not php_exists.stat.exists
        ignore_errors: yes
    
    -   name: Applying role PHP-Versions
        command: mv ~/.ansible/roles/geerlingguy.php-versions ~/.ansible/roles/pwslab.php-versions
        when: not php_exists.stat.exists
        ignore_errors: yes

    -   name: Applying role MYSQL
        command: mv ~/.ansible/roles/geerlingguy.mysql ~/.ansible/roles/pwslab.mysql
        when: not mysql_exists.stat.exists
        ignore_errors: yes

    -   name: Applying role Apache
        command: mv ~/.ansible/roles/geerlingguy.apache ~/.ansible/roles/pwslab.apache
        when: not apache_exists.stat.exists
        ignore_errors: yes

    -   name: Installing Apache
        include_role:
            name: pwslab.apache
        when: not apache_exists.stat.exists

    - name: Installing PHP-Versions
      include_role:
          name: pwslab.php-versions
      when: 
        - not php_exists.stat.exists
        - not cent_os.stdout | regex_search("CentOS Linux release 8")

    - name: Installing PHP
      include_role:
          name: pwslab.php
      when: 
        - not php_exists.stat.exists
        - cent_os.stdout | regex_search("CentOS")
      vars:
        php_webserver_daemon: "httpd"

    -   name: Installing MYSQL
        include_role:
              name: pwslab.mysql
        when: not mysql_exists.stat.exists
    
    -   name: Installing Zabbix
        include_role:
            name: pwslab.zabbix

    